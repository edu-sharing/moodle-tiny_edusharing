define("tiny_edusharing/eduSubmit",["exports","./options","./repository","core/str","core/config","core/modal","./common","core/templates"],(function(_exports,_options,_repository,_str,_config,_modal,_common,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Script eduSubmit.js
   *
   * @module      tiny_edusharing/eduSubmit
   * @copyright   2024 metaVentis GmbH <http://metaventis.com>
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   *
   * This script contains all logic to be executed when the user saves the changes they made in the editor
   * by clicking the "save changes" button.
   * It also contains the logic for keeping score of es elements already present in the section opened.
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initExistingElements=_exports.initEventHandler=void 0,_config=_interopRequireDefault(_config),_modal=_interopRequireDefault(_modal);const formEditorsMap=new WeakMap,initialElementsMap=new WeakMap;_exports.initEventHandler=editor=>{const form=editor.getContainer().closest("form");if(null!==form&&"function"==typeof form.submit){let editors=formEditorsMap.get(form);editors||(editors=new Set,formEditorsMap.set(form,editors)),editors.add(editor),form.dataset.esSubmitHook||(form.dataset.esSubmitHook="1",form.addEventListener("submit",(async event=>{if("1"===form.dataset.esBypassSubmit)return void delete form.dataset.esBypassSubmit;const submitter=event.submitter;if(!submitter||"id_submitbutton"!==submitter.id&&"id_submitbutton2"!==submitter.id)return;event.preventDefault();const formEditors=formEditorsMap.get(form)||new Set;try{await Promise.all([...formEditors].map((editor=>convertForSubmit(editor))))}finally{if(form.dataset.esBypassSubmit="1","id_submitbutton"===submitter.id){const hidden=document.createElement("input");hidden.type="hidden",hidden.name="submitbutton",hidden.value="1",form.appendChild(hidden)}form.submit()}})))}};const convertForSubmit=async editor=>{const initialElements=initialElementsMap.get(editor)||[];let showIframeRemovalDialog=!1;const iterateAsync=async domNode=>{if(domNode.hasChildNodes())for(const node of domNode.childNodes)await iterateAsync(node);void 0!==domNode.classList&&domNode.classList.contains("edusharing_atto")&&await(async domNode=>{let link=domNode.getAttribute("img"===domNode.nodeName.toLowerCase()?"src":"href"),searchParams=new URL(link).searchParams,indexOfElement=initialElements.indexOf(parseInt(searchParams.get("resourceId")));if(indexOfElement>=0){if(initialElements.splice(indexOfElement,1),null!==domNode.getAttribute("data-edited")&&""!==domNode.getAttribute("data-edited")){let ajaxParams={eduStructure:{id:parseInt(searchParams.get("resourceId")),courseId:parseInt((0,_options.getCourseId)(editor)),objectUrl:searchParams.get("object_url")}};void 0===(await(0,_repository.updateInstance)(ajaxParams)).id&&window.console.log("Error updating instance"),domNode.removeAttribute("data-edited")}}else{let ajaxParams={eduStructure:{name:searchParams.get("title"),objectUrl:searchParams.get("object_url"),courseId:parseInt((0,_options.getCourseId)(editor)),objectVersion:searchParams.get("window_version")}},response=await(0,_repository.addEduSharingInstance)(ajaxParams);if(void 0!==response.id){let isImage="img"===domNode.nodeName.toLowerCase(),previewUrl="".concat(_config.default.wwwroot,"/mod/edusharing/preview.php")+"?resourceId="+response.id+"&"+searchParams.toString();domNode.setAttribute(isImage?"src":"href",previewUrl)}}})(domNode),domNode.nodeType===Node.TEXT_NODE&&domNode.textContent.includes("<iframe")&&await(async domNode=>{const tempDiv=document.createElement("div");tempDiv.innerHTML=domNode.textContent;const iframes=tempDiv.querySelectorAll("iframe.es-embed-iframe");for(const iframe of iframes)if(iframe.getAttribute("data-repo-id")===(0,_options.getRepoId)(editor)){const replacement=await getIframeReplacementContent(editor,iframe);""!==replacement?iframe.outerHTML=replacement:(iframe.remove(),showIframeRemovalDialog=!0)}else iframe.remove(),showIframeRemovalDialog=!0;iframes.length>0&&domNode.replaceWith(...tempDiv.childNodes)})(domNode),domNode instanceof HTMLIFrameElement&&void 0!==domNode.classList&&domNode.classList.contains("es-embed-iframe")&&domNode.getAttribute("data-repo-id")===(0,_options.getRepoId)(editor)&&await(async domNode=>{const replacement=await getIframeReplacementContent(editor,domNode);""!==replacement?domNode.outerHTML=replacement:(domNode.remove(),showIframeRemovalDialog=!0)})(domNode)},container=window.document.createElement("div");container.innerHTML=editor.getContent(),await iterateAsync(container),editor.setContent(container.innerHTML);for(const resourceId of initialElements)await(0,_repository.deleteEduSharingInstance)({eduDeleteStructure:{id:resourceId,courseId:parseInt((0,_options.getCourseId)(editor))}});if(showIframeRemovalDialog){const translatedMessage=await new Promise((resolve=>{(0,_str.get_string)("iframeRemovalInfo","tiny_edusharing").done(resolve)})),translatedTitle=await new Promise((resolve=>{(0,_str.get_string)("iframeRemovalTitle","tiny_edusharing").done(resolve)})),modal=await _modal.default.create({title:translatedTitle,body:"<p>"+translatedMessage+"</p>",footer:'<button type="button" class="btn btn-primary" data-action="confirm">OK</button>',show:!0,removeOnClose:!0});await new Promise((resolve=>{modal.getRoot().on("click",'[data-action="confirm"]',resolve),modal.getRoot().on("hidden.bs.modal",resolve)}))}initialElementsMap.set(editor,[])},getIframeReplacementContent=async(editor,domNode)=>{const iframeSrc=domNode.getAttribute("src");try{var _urlSearchParams$get;const urlSearchParams=new URL(iframeSrc).searchParams,nodeId=urlSearchParams.get("node_id"),version=null!==(_urlSearchParams$get=urlSearchParams.get("version"))&&void 0!==_urlSearchParams$get?_urlSearchParams$get:"0",mimeType=urlSearchParams.get("mimetype"),title=domNode.getAttribute("title"),mediaType=domNode.getAttribute("data-mediatype"),width=domNode.getAttribute("width"),height=domNode.getAttribute("height"),ccrepUrl="ccrep://"+encodeURIComponent((0,_options.getRepoId)(editor))+"/"+encodeURIComponent(nodeId);if(nodeId){const ajaxParams={eduStructure:{name:title,objectUrl:ccrepUrl,courseId:parseInt((0,_options.getCourseId)(editor)),objectVersion:version}},response=await(0,_repository.addEduSharingInstance)(ajaxParams);if(void 0!==response.id){let previewUrl="".concat(_config.default.wwwroot,"/mod/edusharing/preview.php")+"?resourceId="+response.id+"&nodeId="+nodeId+"&mimetype="+mimeType+"&mediatype="+mediaType+"&width="+width+"&height="+height;return(await(0,_templates.renderForPromise)("".concat(_common.component,"/content"),{edusharingImg:"ref"!==mediaType,edusharingRef:"ref"===mediaType,edusharingPreviewSrc:previewUrl,edusharingTitle:title.toString(),edusharingInsertCaption:!1,edusharingCaption:"",edusharingWidth:width.toString(),edusharingHeight:height.toString(),edusharingStyle:"",dataEdited:!1})).html}}return""}catch(e){return window.console.error(e),""}};_exports.initExistingElements=editor=>{const iterate=domNode=>{if(domNode.hasChildNodes())for(const node of domNode.childNodes)iterate(node);if(void 0!==domNode.classList&&domNode.classList.contains("edusharing_atto")){let link=domNode.getAttribute("img"===domNode.nodeName.toLowerCase()?"src":"href"),uri=new URL(link);const arr=initialElementsMap.get(editor)||[];arr.push(parseInt(uri.searchParams.get("resourceId"))),initialElementsMap.set(editor,arr)}},container=window.document.createElement("div");container.innerHTML=editor.getContent(),iterate(container)}}));

//# sourceMappingURL=eduSubmit.min.js.map