{"version":3,"file":"eduSubmit.min.js","sources":["../src/eduSubmit.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Script eduSubmit.js\n *\n * @module      tiny_edusharing/eduSubmit\n * @copyright   2024 metaVentis GmbH <http://metaventis.com>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n * This script contains all logic to be executed when the user saves the changes they made in the editor\n * by clicking the \"save changes\" button.\n * It also contains the logic for keeping score of es elements already present in the section opened.\n */\n\nimport {getCourseId} from \"./options\";\nimport {addEduSharingInstance, deleteEduSharingInstance, updateInstance} from \"./repository\";\nimport Config from 'core/config';\n\nconst formEditorsMap = new WeakMap();\n\n// Per-editor initial elements.\nconst initialElementsMap = new WeakMap();\n\nexport const initEventHandler = (editor) => {\n    const container = editor.getContainer();\n    const form = container.closest(\"form\");\n    if (form !== null && typeof form.submit === \"function\") {\n        let editors = formEditorsMap.get(form);\n        if (!editors) {\n            editors = new Set();\n            formEditorsMap.set(form, editors);\n        }\n        editors.add(editor);\n\n        if (!form.dataset.esSubmitHook) {\n            form.dataset.esSubmitHook = \"1\";\n            form.addEventListener('submit', async(event) => {\n                if (form.dataset.esBypassSubmit === \"1\") {\n                    delete form.dataset.esBypassSubmit;\n                    return;\n                }\n                const submitter = event.submitter;\n                if (!submitter || (submitter.id !== \"id_submitbutton\" && submitter.id !== \"id_submitbutton2\")) {\n                    return;\n                }\n                event.preventDefault();\n\n                const formEditors = formEditorsMap.get(form) || new Set();\n                try {\n                    await Promise.all([...formEditors].map(editor => convertForSubmit(editor)));\n                } finally {\n                    form.dataset.esBypassSubmit = \"1\";\n                    if (submitter.id === \"id_submitbutton\") {\n                        const hidden = document.createElement('input');\n                        hidden.type = 'hidden';\n                        hidden.name = 'submitbutton';\n                        hidden.value = '1';\n                        form.appendChild(hidden);\n                    }\n                    form.submit();\n                }\n            });\n        }\n    }\n};\n\nconst convertForSubmit = async(editor) => {\n    const initialElements = initialElementsMap.get(editor) || [];\n    const iterateAsync = async domNode => {\n        if (domNode.hasChildNodes()) {\n            for (const node of domNode.childNodes) {\n                await iterateAsync(node);\n            }\n        }\n        if (domNode.classList !== undefined && domNode.classList.contains('edusharing_atto')) {\n            let link = domNode.getAttribute(domNode.nodeName.toLowerCase() === 'img' ? 'src' : 'href');\n            let uri = new URL(link);\n            let searchParams = uri.searchParams;\n            let indexOfElement = initialElements.indexOf(parseInt(searchParams.get('resourceId')));\n            if (indexOfElement >= 0) {\n                initialElements.splice(indexOfElement, 1);\n                if (domNode.getAttribute('data-edited') !== null && domNode.getAttribute('data-edited') !== \"\") {\n                    let ajaxParams = {\n                        eduStructure: {\n                            id: parseInt(searchParams.get('resourceId')),\n                            courseId: parseInt(getCourseId(editor)),\n                            objectUrl: searchParams.get('object_url')\n                        }\n                    };\n                    let response = await updateInstance(ajaxParams);\n                    if (response.id === undefined) {\n                        window.console.log('Error updating instance');\n                    }\n                    domNode.removeAttribute('data-edited');\n                }\n            } else {\n                let ajaxParams = {\n                    eduStructure: {\n                        name: searchParams.get('title'),\n                        objectUrl: searchParams.get('object_url'),\n                        courseId: parseInt(getCourseId(editor)),\n                        objectVersion: searchParams.get('window_version')\n                    }\n                };\n                let response = await addEduSharingInstance(ajaxParams);\n                if (response.id !== undefined) {\n                    let isImage = domNode.nodeName.toLowerCase() === 'img';\n                    let previewUrl = `${Config.wwwroot}/mod/edusharing/preview.php`\n                        + '?resourceId=' + response.id + '&' + searchParams.toString();\n                    domNode.setAttribute(isImage ? 'src' : 'href', previewUrl);\n                }\n            }\n        }\n    };\n    const container = window.document.createElement('div');\n    container.innerHTML = editor.getContent();\n    await iterateAsync(container);\n    editor.setContent(container.innerHTML);\n    for (const resourceId of initialElements) {\n        await deleteEduSharingInstance({\n            eduDeleteStructure: {\n                id: resourceId,\n                courseId: parseInt(getCourseId(editor))\n            }\n        });\n    }\n    initialElementsMap.set(editor, []);\n};\n\nexport const initExistingElements = editor => {\n    const iterate = domNode => {\n        if (domNode.hasChildNodes()) {\n            for (const node of domNode.childNodes) {\n                iterate(node);\n            }\n        }\n        if (domNode.classList !== undefined && domNode.classList.contains('edusharing_atto')) {\n            let link = domNode.getAttribute(domNode.nodeName.toLowerCase() === 'img' ? 'src' : 'href');\n            let uri = new URL(link);\n            const arr = initialElementsMap.get(editor) || [];\n            arr.push(parseInt(uri.searchParams.get('resourceId')));\n            initialElementsMap.set(editor, arr);\n        }\n    };\n    const container = window.document.createElement('div');\n    container.innerHTML = editor.getContent();\n    iterate(container);\n};\n"],"names":["formEditorsMap","WeakMap","initialElementsMap","editor","form","getContainer","closest","submit","editors","get","Set","set","add","dataset","esSubmitHook","addEventListener","async","esBypassSubmit","submitter","event","id","preventDefault","formEditors","Promise","all","map","convertForSubmit","hidden","document","createElement","type","name","value","appendChild","initialElements","iterateAsync","domNode","hasChildNodes","node","childNodes","undefined","classList","contains","link","getAttribute","nodeName","toLowerCase","searchParams","URL","indexOfElement","indexOf","parseInt","splice","ajaxParams","eduStructure","courseId","objectUrl","window","console","log","removeAttribute","objectVersion","response","isImage","previewUrl","Config","wwwroot","toString","setAttribute","container","innerHTML","getContent","setContent","resourceId","eduDeleteStructure","iterate","uri","arr","push"],"mappings":"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"}